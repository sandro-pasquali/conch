<html>
<head>
<meta charset="utf-8" />
<script src="/sse.js"></script>
<script>

"use strict";

this.onerror = function() {
	console.log("error");
}

function now() {
  var performance = window.performance;
  if (performance && performance.now) {
    return performance.now();
  }
  return new Date().getTime();
}

var lastSendedMessageId = Infinity;
var lastEventId = null;
var lastSendedTime = null;
var msgs = document.createDocumentFragment();
var es = new EventSource('events');

function checkId() {
  if (lastEventId >= lastSendedMessageId) {
    lastSendedMessageId = Infinity;
    var div = document.createElement('div');
    div.className = 'ping';
    div.innerHTML = ' (ping: ' + (now() - lastSendedTime).toFixed(0) + 'ms) ';
    msgs.insertBefore(div, msgs.firstChild);
  }
}

es.addEventListener('message', function (event) {
  lastEventId = +event.lastEventId;
  var div = document.createElement('div');
  var text = document.createTextNode(event.data);
  div.appendChild(text);
  msgs.insertBefore(div, msgs.firstChild);
  checkId();
});


function post() {
  var message = document.getElementById('message').value;
  if (!message) {
    return false;
  }
  document.getElementById('message').value = '';

  lastSendedTime = now();
  lastSendedMessageId = Infinity;

  var xhr = new XMLHttpRequest();
  xhr.open('POST', '?message=' + encodeURIComponent(message), true);
  xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
  xhr.onreadystatechange = function () {
    if (xhr.readyState === 4) {
      lastSendedMessageId = +xhr.responseText || Infinity;
      checkId();
    }
  };
  xhr.send(null);

  return false;
}

window.onload = function () {

  es.addEventListener('open', function() {
  	console.log("connection opened");
  });
  es.addEventListener('error', function() {
  	console.log(arguments)
  	console.log("connection error");
  });

  var m = document.getElementById('msgs');
  m.appendChild(msgs);
  msgs = m;
  document.querySelector("form").onsubmit = function (e) {
    post();
    return false;
  };
};

</script>

</head>
<body>

    <form action="?">
    	<input type="text" name="message" id="message" maxlength="140" required />
    	<input type="submit" value="Send message" />
    </form>
    <div id="msgs"></div>


</body>
</html>